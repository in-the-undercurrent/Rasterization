# Rasterization
将全球范围内的遥感图像的矢量图像栅格化
0背景
GOME-2（Global Ozone Monitoring Experiment-2）是一个搭载在欧洲气象卫星 Metop 上的遥感仪器，用于监测地球大气中的臭氧、氮氧化物、二氧化硫等痕量气体。GOME-2 Level 2 数据产品提供了对这些痕量气体柱浓度的高精度测量，涵盖了全球范围的观测数据。
这些数据产品分为不同的处理和时间类别，包括：
•	近实时 (NRT) 数据：这些是最近 3 个月内生成的数据，涵盖了总臭氧柱浓度（O3）、总氮氧化物和对流层氮氧化物柱浓度、二氧化硫柱浓度（SO2）以及对流层甲醛柱浓度（HCHO）等。
•	离线和再处理数据：这些数据涵盖了从任务开始以来的历史数据，包含了更为详细的分析，如总溴氧化物柱浓度（BrO）、总水汽柱浓度（H2O）等，特别是针对 Metop-A 和 Metop-B 观测的溴氧化物和次氯酸根氧化物（OClO）的再处理数据集。
Level 2 数据产品为大气研究人员提供了关键的气体浓度信息，支持全球大气污染监测、气候变化研究和臭氧层保护等工作。GOME-2 Level 2 数据产品采用 NetCDF（Network Common Data Form）格式存储。NetCDF 是一种广泛用于科学数据存储的文件格式，特别适用于处理大规模、多维度的数据集。
本次实验使用GOME-2 Level 2 数据产品，时间跨度为2007-2018，时间分辨率为逐小时，原始数据总大小为836GB，数据大小见图一。使用的数据处理平台为武汉大学超算中心。
 
图2 需要处理的原始数据
1实验过程
本实验使用2008-2019年期间逐小时的GOME-2 Level 2 矢量数据产品处理成逐天（空间分辨率为0.25°x 0.25°）的level 3的栅格数据。
将level 2数据整理成level 3数据的过程如图2，每个栅格的值由栅格多边形所占的相对百分比乘以该多边形的值所得。这个算法本质上是将面状矢量转换为栅格，但由于面状矢量存在叠置现象并且在整个地球上存在数以十万计的多边形矢量，导致该栅格化过程较为复杂。一个面状矢量经过若干个栅格，求出其中每个栅格与该面状矢量所交面积。对所有面状矢量进行完上述步骤以后，每个栅格就有了与其相交的所有面状矢量的值及其相交面积权重。最终每个栅格的属性值即等于该与其相交的所有面状矢量的值及其相交面积权重。
 
图2 面状矢量的栅格化过程举例

  栅格化过程使用python语言实现，由于栅格化过程存在叠置且要获取每个栅格中面状矢量的面积百分比，导致不能使用现有的库以及GIS软件来进行。
   本文需要将15年的数据逐天处理成栅格数据（栅格数据是全球范围内0.25°*0.25°），而所给定的原始数据为分小时数据，所以处理程序的处理速度必须要很快。而由于上述栅格化过程的复杂，导致该栅格化过程不能使用矩阵方法进行，即使用GPU进行加速，所以本次实验是一个依靠多CPU核心的多进程任务。考虑到需要处理的数据量很大、需要的CPU性能较高，所以本实验在武汉大学的超算中心上进行，如图3。在超算中心的服务器上提交作业时，使用接Xshell 8软件来连接到超算中心服务器，进行提交作业、查看作业运行情况、安装程序环境、提交linux命令等操作；使用FileZilla软件用于文件传输，并搭建简单的的图形界面。
 
图3 Xshell上武汉大学超算中心的作业任务
待处理的文件为HDF5格式的逐个小时的文件，其中本实验需要提取的大气污染物被储存在若干个多边形中。一个HDF5格式文件含有某个小时多个多边形，而level 3文件需要将一天内所有的HDF5文件整合，并且把这些文件中所包含的多个多边形栅格化到全球范围内。整体代码为367行，主要分为5个部分：
•  读取HDF5文件：程序从存储NO2浓度数据的HDF5文件中读取必要的地理信息（如纬度和经度）以及NO2浓度数据。NO2数据经过单位转换后，转换为气溶胶单位（DU）。
•  处理跨越子午线的多边形：程序通过判断多边形是否跨越了国际日期变更线（子午线），并在需要时对经度进行对称变换，以确保正确的地理定位。这样做的目的是避免跨越子午线的区域带来错误的坐标计算。
•  网格化处理：将每个多边形的NO2浓度与地理网格进行交集计算。对于每个网格单元，如果该单元与多边形有交集，就计算交集区域的面积，并基于此面积计算NO2浓度的百分比。程序通过细化网格划分（0.25°），将地球表面分成更精细的栅格单元。
•  去重与加权计算：当多个多边形覆盖相同的栅格单元时，程序对重复的单元进行加权处理，确保每个栅格单元的NO2浓度值正确反映其覆盖的比例。
•  生成GeoTIFF文件：最后，程序将计算后的结果（每个栅格的NO2浓度）存储为GeoTIFF格式的地图文件。GeoTIFF格式被广泛应用于地理信息系统（GIS）中，可以用于可视化和进一步的分析。
 
图4 程序最终输出TIFF文件
2栅格化算法的选择
本实验的核心部分为面状矢量栅格化，本文也考虑过三种栅格化的实现方法。
2.1 gdal.Rasterize 方法
GDAL（Geospatial Data Abstraction Library）是一个用于处理栅格和矢量数据的开源库，
广泛应用于地理空间数据的读取、写入和转换。GDAL提供了多种栅格化方法，用于将矢量数据（如多边形、点、线）转换为栅格数据。gdal.Rasterize是GDAL中最常用的栅格化方法之一，主要用于将矢量数据转换为栅格格式。它支持通过指定参数来选择栅格单元的值及其他细节。
但该方法有2个问题：
其一是gdal.Rasterize方法对一个多边形就会输出一层栅格。而仅仅一个HDF5文件就有数个多边形，如果将这多个多边形直接栅格化，再将这多个栅格合并，计算的复杂度将前所未有的大。
其二是gdal.Rasterize不能根据栅格面积占比来完成栅格的赋值，无法满足图2的栅格化过程（见图2）这也就意味着本实验无法使用现成的方法完成栅格化，只能自己实现栅格化。
2.2细分栅格化
本文最终要生成空间分辨率为0.25°x 0.25°的栅格文件，那么，可以直接将整个本来将一份栅格一分为100，先生成空间分辨率为0.025°x 0.025°的栅格，再将细分后的栅格重分类整合为0.25°x 0.25°。这种方法固然可以使用gdal.Rasterize这个已有的轮子，但是生成0.025°x 0.025°的栅格意味着一景图像就有103,680,000个栅格。 
经过测试，使用该算法输出一天的数据需要18小时，这个方法的时间复杂度显然是不可接受的。
2.3重叠区域法
由于处理的数据量很大，经过多次测试，本文选定了重叠区域法。该算法是将需要栅格化的面状矢量构建最小外包矩形，再对最小外包矩形内的栅格与该栅格求交以获得面积百分比，并以表格的形式输出每个面状矢量所覆盖的栅格。该表格的每一行为一个栅格，列分别为该栅格所处的行、列、该面状矢量的值以及该面状矢量该栅格的面积。处理完多个面状矢量以后，程序已经生成好了与相对应面状矢量相对应的表格，再将该表格拼接，由于一个栅格可能被多个面状矢量所包含，所以该总表中会出现重复的栅格，这时再对该总表进行数据合并，重复出现的栅格属性值其所交的矢量属性值乘以该栅格与面状矢量所交的面积百分比决定。
	经测试，该方法经过多进程优化后，在武大超算节点上输出一天的数据需要2分钟左右，如图5。
 
图5 武大超算中心上的输出文件
3实验过程的异常处理
3.1经度的对称问题
本次实验中原始数据的经度范围为0-360°，但实际上地球为椭球体，0°和360°是一条线，这也导致穿过0°经线的多边形在程序里被视为一个横跨整个坐标系的巨大的矩形，这样的多边形被栅格化，会使得覆盖全球的大部分区域栅格被识别为多边形的横跨区域，如图6。
  
图6 左图未考虑经度对称性问题导致多边形栅格化产生“拖影”与右图理想结果

为了解决这个问题，本实验考虑过两种方法
第一种是将一个每个横跨0°经线的多边形使用0°经线进行切割，把其切成0°经线右侧和360°经线左侧两部分，再对两部分分别栅格化。
第二种是将所有横跨0°经线的多边形进行平移对称操作，将0°-360°的经度坐标其平移至-180°-180°的经线坐标内，这样，原本被经线切割成两块的多边形就会处于整个坐标系的中央，再对平移过的多边形进行栅格化，并对输出的栅格进行再一轮平移和对称，使其回复到0-360°经线。
显然，前者的方案会徒增不少计算量，故本实验使用第二种方式，即对经度进行对称平移，如图7。
 
图7 横跨0°经线的多边形进行平移对称操作
3.2多进程问题
本实验在对多边形进行栅格化的过程中，需要多次进行多次相似的操作（算与一个多边形相交的栅格），这样的操作之间不需要互相同步信息，且可重复性极强，因此适合使用多进程来执行。、
多进程是指一个程序中同时运行多个独立的进程。每个进程都有独立的内存空间、资源和运行环境。多线程是指一个程序中的多个执行流（线程）在同一个进程内运行，线程之间共享内存空间和资源。由于每个多边形都是独立的，并没有共享信息的必要，况且多线程实际上并不能加速程序，因此采取多进程是合适的策略。又因为每个进程的计算较为复杂，且需要调包等操作，所以使用GPU加速是不行的，只能依赖多核CPU来进行程序的加速。
本实验在对多边形栅格化，和合并栅格的过程中使用了两次多进程，如图8。Python的多进程本质上是多次运行同一份脚本，这就使得非多进程部分的代码必须使用if __name__ == '__main__':函数进行保护，以防其余部分代码在多进程过程中被重复执行。
 
图8 多进程部分
3.3超算平台使用问题
 武汉大学超级计算中心集群计算系统，由475台CPU服务器、168台KNL服务器和174台GPU服务器组成，总体计算能力理论峰值为6650万亿次。
超算平台使用LINUX命令行进行操作，并且作业的运行需要编写batch脚本，该脚本的编码格式与一般win系统上的CRLF不同，这点需要留意，除此以外，在LINUX上python的运行环境需要自行安装。除此以外，由于需要处理的原始数据多达800G,python程序中必须设定异常处理，以防出现某个时刻的原始数据出错导致整个程序终止。
4结果
在武大超算中心输出结果后，使用matlab进行批处理将一个月的所有天数合并成一天得到全世界范围内的0.25*0.25°大气污染物浓度图。所有数据输出后可得到2008-2019年的逐天0.25*0.25°大气污染物浓度栅格数据。
 
图9 一个月的输出结果




